<!DOCTYPE HTML>
<html>
<head>
	<title>Test area</title>
	<link rel="stylesheet" href="stylesheet.css">
	<link rel="stylesheet" href="jquery-ui.css">
</head>
<body>
	<script src="jquery-2.1.1.min.js"></script>
	<script src="jquery-ui-1.10.4.min.js"></script>
	<script src="euler/functions.js"></script>
	<script src="BigInt.js"></script>
	<script>
		"use strict";
		var eulerProblems = [];
		var eulerRequests = [];
		function log(message) {
			console.log(message);
		}
		function add_problem(problems, problemNum) {
			var i = problemNum;
			var script = document.createElement("script");
			script.src = "euler/" + i + ".js";
			script.type = "text/Javascript";
			var controls = "<span class=\"problem_control\"><input type=\"button\" value=\"Run\" id=\"problem" + i + "_run\"><\/span>";
			problems.append("<div class=\"problem\" id=\"problem" + i + "\">Problem " + i + ":" + controls + "<br><span id=\"problem" + i + "_result\"><\/span><\/div>");
			(function(i) {
				var loaded = false;
				var problem_div = $("#problem" + i);
				var result_span = $("#problem" + i + "_result");
				var run = $("#problem" + i + "_run");
				run.click(function(_, next, time) {
					var blockingRequestData = null;
					var start, result, elapsed;
					if(loaded) {
						if(eulerRequests[i]) {
							var success = false;
							try {
								blockingRequestData = eulerRequests[i]();
								success = true;
							} catch(Exception) {
								elapsed = 0;
								result = { result: Exception, expected: "not failing" };
							}
							if(success) {
								start = new Date().getTime();
								result = eulerProblems[i](blockingRequestData);
								elapsed = new Date().getTime() - start;
							}
						} else {
							start = new Date().getTime();
							result = eulerProblems[i](blockingRequestData);
							elapsed = new Date().getTime() - start;
						}
					} else {
						elapsed = 0;
						result = {result: "not yet loaded", expected: "clicking while loaded"};
					}
					if(time) {
						time.elapsed += elapsed;
					}
					if(result_span.text() == "") {
						$.when(problem_div.height($(problem_div).height() + 5)
						.animate({height: ($(problem_div).height() * 1.55) + "px"}, {duration: 50})).done(next);
					} else {
						if(next) {
							next();
						}
					}
					result_span.text("Result: " + result.result);
					if(result.result != result.expected) {
						problem_div.css("color", "red");
						result_span.append("; Expected: " + result.expected);
					} else {
						problem_div.css("color", "");
						problem_div.css("background-color", "rgba(0,255,0,.1)");
					}
					var timeScaler = Math.pow(.8 + (elapsed / 1000), 4) / 2;
					if((elapsed / 1000) < .05) {
						timeScaler = 0;
					}
					var timeColor = "color: rgb(" + Math.round(timeScaler * 255) + ",0,0)";
					result_span.append("; took <span style='" + timeColor + "'>" + elapsed / 1000 + " seconds<\/span>.");
				});
				script.onload = function() {
					loaded = true;
				}
			})(i);
			document.getElementsByTagName("head")[0].appendChild(script);
		}
		var problem_count = 79;
		var run_all = function(){alert("not ready");}; //empty function while waiting for document ready
		var exclude = [66, 68, 75];  // euler problems I skipped
		var otherProblems = [81, 89, 96, 97, 99, 104, 197, 204, 206, 243];  // other problems
		$(document).ready(function() {
			var problems = $("#problems");
			var progressBar = $("#progressbar");
			for(var i = 1; i <= problem_count; ++i) {
				if (exclude.indexOf(i) != -1) {
					continue;
				}
				add_problem(problems, i);
			}
			for(var i = 0; i < otherProblems.length; ++i) {
				add_problem(problems, otherProblems[i]);
			}
			run_all = function() {
				var total = $("#total_time")[0];

				var problems = [];

				for(var problem in eulerProblems) {
					problems.push(function(problem) {
						return function(done, time) {
							$("#problem" + problem + "_run").trigger("click", [done, time]);
						}
					}(problem));
				}

				var time = {elapsed: 0};
				var progressBarValue = $('.ui-progressbar-value').addClass('ui-corner-right');
				progressBar.progressbar({value:.001});
				var runProblem = function(problemNum) {
					var problem = problems[problemNum];
					if(problem) {
						problem(function() {
							total.innerHTML = time.elapsed + "ms (" + (problemNum+1) + "/" + problems.length + ")";
							progressBarValue.stop(true).animate({width: (100*(problemNum+1))/problems.length + "%"}, 50);
							window.setTimeout(function() {
								runProblem(problemNum + 1);
							}, 5);
						}, time);
					}
				};
				runProblem(0);
			}
			progressBar.progressbar();
			var progressBarValue = $('.ui-progressbar-value').addClass('ui-corner-right');

		});
	</script>
	<div id="global_controls">
		<div><span id="total_time"></span><input type="button" value="Run all" onclick="run_all()"></div>
		<div id="progressbar"></div>
	</div>
	<div id="problems"></div>
	<div><a href="tile.html">Tile game test</a></div>
	<div><a href="dom_manip.html">Dom manipulation test</a></div>
	<div><a href="astar.html">A*</a></div>
</body>
</html>
